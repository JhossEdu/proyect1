<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Convertidor a WebP — XTravel Peru</title>
  <meta name="description" content="Convierte JPG/PNG a WebP en el navegador con renombrado normalizado y registro de conversión. Privado: no sube tus imágenes al servidor." />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0b1220,#101522 40%,#0b1220);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--text)}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    header{display:flex;gap:14px;align-items:center;margin-bottom:22px}
    header .logo{width:42px;height:42px;border-radius:12px;background:radial-gradient(circle at 30% 30%,#22c55e,transparent 55%),radial-gradient(circle at 70% 70%,#3b82f6,transparent 55%),#0b1220;border:1px solid #1f2937}
    h1{margin:0;font-weight:800;letter-spacing:.2px}
    .card{background:rgba(17,24,39,.7);backdrop-filter:blur(8px);border:1px solid #1f2937;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:880px){.grid{grid-template-columns:1.3fr .7fr}}
    .pane{padding:18px}
    .pane h2{margin:0 0 10px;font-size:18px}
    .drop{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;border:2px dashed #263244;border-radius:16px;min-height:220px;background:#0b1220}
    .drop.drag{border-color:#3b82f6;background:#0b1220}
    .muted{color:var(--muted)}
    .controls{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center}
    label{font-size:14px;color:#cbd5e1;min-width:max-content}
    input[type="text"],input[type="number"],input[type="file"]{appearance:none;background:#0b1220;border:1px solid #1f2937;color:var(--text);border-radius:12px;padding:10px 12px;width:100%}
    input[type="range"]{width:100%}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #1f2937;background:#0b1220;color:#cbd5e1}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;font-weight:700;cursor:pointer;color:#0b1220;background:var(--accent);transition:transform .04s ease, box-shadow .2s}
    .btn.secondary{background:var(--accent2);color:white}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .list{max-height:360px;overflow:auto;background:#0b1220;border:1px solid #1f2937;border-radius:12px}
    .item{display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px 12px;border-bottom:1px solid #1f2937}
    .item:last-child{border-bottom:none}
    .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ok{color:#86efac}
    .err{color:#fca5a5}
    footer{margin-top:18px;font-size:12px;color:#9ca3af}
    .tiny{font-size:12px}
    .tag{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid #334155;color:#cbd5e1}
  </style>
  <!-- JSZip para crear ZIP descargable -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Convertidor a WebP — XTravel Peru <span class="tag">100% en el navegador</span></h1>
        <div class="muted tiny">Privado: tus imágenes no se suben a ningún servidor. Ideal para Vercel estático.</div>
      </div>
    </header>

    <div class="card grid">
      <section class="pane">
        <h2>1) Sube o arrastra tus imágenes (JPG/PNG)</h2>
        <div id="drop" class="drop" tabindex="0" role="button" aria-label="Zona para soltar archivos">
          <div>Arrastra y suelta aquí</div>
          <div class="muted tiny">o</div>
          <input id="file" type="file" accept="image/jpeg,image/png" multiple />
          <div class="muted tiny">Se renombrarán y convertirán a WebP</div>
        </div>
      </section>

      <section class="pane">
        <h2>2) Ajustes</h2>
        <div class="controls">
          <div class="row">
            <label for="suffix">Sufijo:</label>
            <input id="suffix" type="text" value="_xtravelperu" />
          </div>
          <div class="row">
            <label for="quality">Calidad WebP: <span id="qval">90</span></label>
          </div>
          <input id="quality" type="range" min="1" max="100" value="90" />
          <div class="kpis">
            <div class="pill"><strong>Normalización</strong>: tildes fuera, espacios→"-", ASCII limpio</div>
            <div class="pill">Resuelve nombres duplicados ( -1, -2, ... )</div>
          </div>
          <div class="row" style="margin-top:6px;gap:12px">
            <button id="btnConvert" class="btn" disabled>Convertir a WebP</button>
            <button id="btnZip" class="btn secondary" disabled>Descargar ZIP</button>
          </div>
        </div>
      </section>
    </div>

    <section class="pane card" style="margin-top:16px">
      <h2>Archivos</h2>
      <div id="list" class="list" aria-live="polite"></div>
      <footer>
        <p>Se generará un <code>conversion_log.txt</code> con el resumen (fecha, calidad, sufijo, éxitos/errores).</p>
      </footer>
    </section>

    <footer>
      Hecho con ❤️ para tu equipo. Todo corre localmente en el navegador.
    </footer>
  </div>

<script>
  // --- Utilidades de normalización (inspirado en tu script Python) ---
  function normalizeBase(name){
    // 1) NFKD para separar diacríticos y luego quitarlos
    let n = name.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
    // 2) Reemplazar guiones largos por "-"
    n = n.replace(/[–—]/g, '-');
    // 3) Separadores comunes → espacio
    n = n.replace(/[\/\\|:;,]+/g, ' ');
    // 4) Espacio → guion
    n = n.replace(/\s+/g, '-');
    // 5) Mantener solo [A-Za-z0-9._-], lo demás → guion
    n = n.replace(/[^A-Za-z0-9_.-]/g, '-');
    // 6) Colapsar múltiples guiones
    n = n.replace(/-{2,}/g, '-');
    // 7) Limpiar extremos - _
    n = n.replace(/^[\-_]+|[\-_]+$/g, '');
    if(!n) n = 'archivo';
    return n;
  }

  function uniqueName(existingSet, filename){
    // filename incluye extensión
    const dot = filename.lastIndexOf('.');
    const base = dot === -1 ? filename : filename.slice(0,dot);
    const ext  = dot === -1 ? '' : filename.slice(dot);
    let cand = filename; let i = 1;
    while(existingSet.has(cand)){
      cand = `${base}-${i}${ext}`; i++;
    }
    existingSet.add(cand);
    return cand;
  }

  async function fileToWebP(file, quality){
    // Carga imagen → canvas → Blob WebP
    const bitmap = await createImageBitmap(file).catch(()=>null);
    if(!bitmap) throw new Error('No se pudo leer la imagen');
    const canvas = document.createElement('canvas');
    canvas.width = bitmap.width; canvas.height = bitmap.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bitmap, 0, 0);
    const q = Math.max(0, Math.min(1, quality/100));
    return new Promise((resolve,reject)=>{
      canvas.toBlob(b=> b? resolve(b) : reject(new Error('toBlob falló')), 'image/webp', q);
    });
  }

  // --- Estado ---
  const state = {
    files: [],          // {file, name, status, outName, blob, error}
    outputs: [],        // {name, blob}
    quality: 90,
    suffix: '_xtravelperu',
  };

  // --- DOM ---
  const el = {
    drop: document.getElementById('drop'),
    input: document.getElementById('file'),
    list: document.getElementById('list'),
    btnConvert: document.getElementById('btnConvert'),
    btnZip: document.getElementById('btnZip'),
    quality: document.getElementById('quality'),
    qval: document.getElementById('qval'),
    suffix: document.getElementById('suffix'),
  };

  // --- Handlers subida ---
  function accept(files){
    const arr = Array.from(files).filter(f => /image\/(jpeg|png)/.test(f.type));
    if(!arr.length) return;
    for(const f of arr){
      state.files.push({ file:f, name:f.name, status:'pendiente', outName:null, blob:null, error:null });
    }
    render();
    el.btnConvert.disabled = false;
  }

  el.input.addEventListener('change', e => accept(e.target.files));

  ;['dragenter','dragover'].forEach(ev => el.drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); el.drop.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev => el.drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); el.drop.classList.remove('drag');}));
  el.drop.addEventListener('drop', e => accept(e.dataTransfer.files));

  // Accesibilidad con teclado para abrir file picker
  el.drop.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); el.input.click(); } });

  // Controles
  el.quality.addEventListener('input', e=>{ state.quality = +e.target.value; el.qval.textContent = state.quality; });
  el.suffix.addEventListener('input', e=>{ state.suffix = e.target.value || ''; });

  // Convertir
  el.btnConvert.addEventListener('click', async ()=>{
    el.btnConvert.disabled = true; el.btnZip.disabled = true;
    const usedNames = new Set();
    state.outputs = [];
    for(const it of state.files){
      it.status = 'convirtiendo'; render();
      try{
        const file = it.file;
        const base = it.name.replace(/\.[^.]+$/, '');
        const norm = normalizeBase(base);
        const outBase = `${norm}${state.suffix}`;
        let outName = `${outBase}.webp`;
        outName = uniqueName(usedNames, outName);
        const blob = await fileToWebP(file, state.quality);
        it.status = 'ok'; it.outName = outName; it.blob = blob; it.error = null;
        state.outputs.push({name: outName, blob});
      }catch(err){
        it.status = 'error'; it.error = (err && err.message) ? err.message : String(err);
      }
      render();
    }
    el.btnZip.disabled = state.outputs.length === 0;
  });

  // Descargar ZIP con archivos + log
  el.btnZip.addEventListener('click', async ()=>{
    const zip = new JSZip();
    const folder = zip.folder('convertidas_webp');

    // Guardar imágenes
    for(const out of state.outputs){
      folder.file(out.name, out.blob);
    }

    // Log
    const now = new Date();
    const pad = n => String(n).padStart(2,'0');
    const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

    const ok = state.files.filter(f=>f.status==='ok');
    const er = state.files.filter(f=>f.status==='error');
    let log = '';
    log += `Registro de conversión: ${stamp}\n`;
    log += `Calidad webp: ${state.quality}\n`;
    log += `Sufijo añadido: ${state.suffix}\n\n`;
    log += `Total procesados: ${state.files.length}\n`;
    log += `Éxitos: ${ok.length}\n`;
    log += `Errores: ${er.length}\n\n`;
    log += `DETALLES:\n`;
    for(const f of state.files){
      const final = f.outName ? f.outName : '-';
      const msg = f.status==='ok' ? 'OK' : (f.error ? `ERROR: ${f.error}` : '');
      log += `${f.name} -> ${final} -> ${msg}\n`;
    }
    folder.file('conversion_log.txt', log);

    const blob = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `webp_convertidas_${Date.now()}.zip`;
    document.body.appendChild(a); a.click(); a.remove();
  });

  function render(){
    el.list.innerHTML = '';
    if(state.files.length===0){
      el.list.innerHTML = '<div class="item"><div class="muted">Aún no hay archivos...</div></div>';
      return;
    }
    for(const it of state.files){
      const row = document.createElement('div'); row.className='item';
      const left = document.createElement('div'); left.className='name'; left.textContent = it.name;
      const right = document.createElement('div');
      if(it.status==='ok'){
        right.innerHTML = `<span class="ok">✔ ${it.outName}</span>`;
      }else if(it.status==='error'){
        right.innerHTML = `<span class="err">✖ ${it.error}</span>`;
      }else if(it.status==='convirtiendo'){
        right.innerHTML = '<span class="muted">Convirtiendo…</span>';
      }else{
        right.innerHTML = '<span class="muted">Pendiente</span>';
      }
      row.appendChild(left); row.appendChild(right);
      el.list.appendChild(row);
    }
  }
</script>
</body>
</html>
