<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Convertidor a WebP — XTravel Peru</title>
  <meta name="description" content="Convierte JPG/PNG a WebP en el navegador con renombrado normalizado y registro de conversión. Privado: no sube tus imágenes al servidor." />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0b1220,#101522 40%,#0b1220);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--text)}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
  header{display:flex;gap:14px;align-items:center;margin-bottom:22px}
  /* Contenedor del logo: mantiene el diseño original pero permite una imagen dentro */
  header .logo{width:64px;height:64px;border-radius:12px;background:radial-gradient(circle at 30% 30%,#22c55e,transparent 55%),radial-gradient(circle at 70% 70%,#3b82f6,transparent 55%),#0b1220;border:1px solid #1f2937;overflow:hidden;display:inline-block;flex:0 0 auto}
  /* Imagen del logo dentro del contenedor */
  header .logo img{width:100%;height:100%;object-fit:cover;display:block}
    @media (max-width:480px){header .logo{width:48px;height:48px}}
    /* Avisos y progreso */
    .notice{padding:10px;border-radius:10px;border:1px solid #1f2937;background:#071022;color:var(--muted);margin-bottom:12px}
    .progressWrap{display:flex;gap:10px;align-items:center}
    .progressBar{height:10px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;overflow:hidden;width:160px}
    .progressFill{height:100%;background:var(--accent);width:0%}
    .thumb{width:64px;height:40px;border-radius:8px;overflow:hidden;display:inline-block;border:1px solid #1f2937}
    .size{font-size:12px;color:var(--muted);margin-left:8px}
    h1{margin:0;font-weight:800;letter-spacing:.2px}
    .card{background:rgba(17,24,39,.7);backdrop-filter:blur(8px);border:1px solid #1f2937;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:880px){.grid{grid-template-columns:1.3fr .7fr}}
    .pane{padding:18px}
    .pane h2{margin:0 0 10px;font-size:18px}
    .drop{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;border:2px dashed #263244;border-radius:16px;min-height:220px;background:#0b1220}
    .drop.drag{border-color:#3b82f6;background:#0b1220}
    .muted{color:var(--muted)}
    .controls{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center}
    label{font-size:14px;color:#cbd5e1;min-width:max-content}
    input[type="text"],input[type="number"],input[type="file"]{appearance:none;background:#0b1220;border:1px solid #1f2937;color:var(--text);border-radius:12px;padding:10px 12px;width:100%}
    /* Estilo personalizado para la barra de calidad WebP */
    input[type="range"]{
      appearance:none; -webkit-appearance:none;
      width:100%;
      height:18px;
      background:transparent;
      margin:6px 0;
    }
    /* WebKit track + thumb */
    input[type="range"]::-webkit-slider-runnable-track{
      height:8px;
      background: linear-gradient(90deg,var(--accent2),var(--accent));
      border-radius:999px;
      border:1px solid #1f2937;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:18px;height:18px;border-radius:50%;
      background:var(--accent);border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4);
      margin-top:-5px; /* center the thumb */
    }
    /* Firefox */
    input[type="range"]::-moz-range-track{
      height:8px;
      background: linear-gradient(90deg,var(--accent2),var(--accent));
      border-radius:999px;border:1px solid #1f2937;
    }
    input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--accent);border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4);}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #1f2937;background:#0b1220;color:#cbd5e1}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;font-weight:700;cursor:pointer;color:#0b1220;background:var(--accent);transition:transform .04s ease, box-shadow .2s}
    .btn.secondary{background:var(--accent2);color:white}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .list{max-height:360px;overflow:auto;background:#0b1220;border:1px solid #1f2937;border-radius:12px}
  .item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;padding:10px 12px;border-bottom:1px solid #1f2937;align-items:center}
    .item:last-child{border-bottom:none}
    .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ok{color:#86efac}
    .err{color:#fca5a5}
    footer{margin-top:18px;font-size:12px;color:#9ca3af}
    .tiny{font-size:12px}
    .tag{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid #334155;color:#cbd5e1}
  </style>
  <!-- JSZip para crear ZIP descargable -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="./" class="logo" aria-label="Inicio">
        <img src="https://xtravelperu.com/wp-content/uploads/2025/10/logo.png" alt="Logo XTravel Peru" />
      </a>
      <div>
  <h1>Convertidor a WebP — XTravel Peru</h1>
      </div>
    </header>

    <div class="card grid">
      <div style="grid-column:1/-1">
        <div id="notice" class="notice">Cargando...</div>
      </div>
      <section class="pane">
        <h2>1) Sube o arrastra tus imágenes (JPG/PNG)</h2>
        <div id="drop" class="drop" tabindex="0" role="button" aria-label="Zona para soltar archivos">
          <div>Arrastra y suelta aquí</div>
          <div class="muted tiny">o</div>
          <input id="file" type="file" accept="image/jpeg,image/png" multiple />
          <div class="muted tiny">Se renombrarán y convertirán a WebP</div>
        </div>
      </section>

      <section class="pane">
        <h2>2) Ajustes</h2>
        <div class="controls">
          <div class="row">
            <label for="suffix">Sufijo:</label>
            <input id="suffix" type="text" value="_xtravelperu" />
          </div>
          <div class="row">
            <label for="quality">Calidad WebP: <span id="qval">90</span></label>
          </div>
          <input id="quality" type="range" min="1" max="100" value="90" />
          <!-- kpis removed: hidden from user per request -->
          <div class="row">
            <label for="allowDownload">Permitir descarga individual:</label>
            <input id="allowDownload" type="checkbox" />
          </div>
          <div class="row">
            <label for="zipFolder">Nombre carpeta ZIP:</label>
            <input id="zipFolder" type="text" value="webp" />
          </div>
          <div class="row" style="margin-top:6px;gap:12px">
            <button id="btnConvert" class="btn" disabled>Convertir a WebP</button>
            <button id="btnZip" class="btn secondary" disabled>Descargar ZIP</button>
          </div>
        </div>
      </section>
    </div>

    <section class="pane card" style="margin-top:16px">
      <h2>Archivos</h2>
      <div id="globalProgress" class="progressWrap" style="display:none;margin-bottom:8px">
        <div class="progressBar" aria-hidden="true"><div id="progressFill" class="progressFill"></div></div>
        <div><button id="btnCancel" class="btn secondary">Cancelar</button></div>
        <div class="size muted" id="progressText"></div>
      </div>
      <div id="list" class="list" aria-live="polite"></div>
      <footer>
        <p>Se generará un <code>conversion_log.txt</code> con el resumen (fecha, calidad, sufijo, éxitos/errores).</p>
      </footer>
    </section>

    <footer>
      Hecho con ❤️ por SoporteTI XTRAVELPERU.
    </footer>
  </div>

<script>
  // --- Utilidades de normalización (inspirado en tu script Python) ---
  function normalizeBase(name){
    // 1) NFKD para separar diacríticos y luego quitarlos
    let n = name.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
    // 2) Reemplazar guiones largos por "-"
    n = n.replace(/[–—]/g, '-');
    // 3) Separadores comunes → espacio
    n = n.replace(/[\/\\|:;,]+/g, ' ');
    // 4) Espacio → guion
    n = n.replace(/\s+/g, '-');
    // 5) Mantener solo [A-Za-z0-9._-], lo demás → guion
    n = n.replace(/[^A-Za-z0-9_.-]/g, '-');
    // 6) Colapsar múltiples guiones
    n = n.replace(/-{2,}/g, '-');
    // 7) Limpiar extremos - _
    n = n.replace(/^[\-_]+|[\-_]+$/g, '');
    if(!n) n = 'archivo';
    return n;
  }

  function uniqueName(existingSet, filename){
    // filename incluye extensión
    const dot = filename.lastIndexOf('.');
    const base = dot === -1 ? filename : filename.slice(0,dot);
    const ext  = dot === -1 ? '' : filename.slice(dot);
    let cand = filename; let i = 1;
    while(existingSet.has(cand)){
      cand = `${base}-${i}${ext}`; i++;
    }
    existingSet.add(cand);
    return cand;
  }

  async function fileToWebP(file, quality){
    // Carga imagen → canvas → Blob WebP
    const bitmap = await createImageBitmap(file).catch(()=>null);
    if(!bitmap) throw new Error('No se pudo leer la imagen');
    const canvas = document.createElement('canvas');
    canvas.width = bitmap.width; canvas.height = bitmap.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bitmap, 0, 0);
    const q = Math.max(0, Math.min(1, quality/100));
    return new Promise((resolve,reject)=>{
      canvas.toBlob(b=> b? resolve(b) : reject(new Error('toBlob falló')), 'image/webp', q);
    });
  }

  // --- Estado ---
  const state = {
    files: [],          // {file, name, status, outName, blob, error}
    outputs: [],        // {name, blob}
    quality: 90,
    suffix: '_xtravelperu',
    supportedWebP: true,
    maxFileMB: 25,
    isCancelled: false,
    allowDownload: false,
    urlMap: new Map(),
  zipFolder: 'webp',
  };

  // --- DOM ---
  const el = {
    drop: document.getElementById('drop'),
    input: document.getElementById('file'),
    list: document.getElementById('list'),
    btnConvert: document.getElementById('btnConvert'),
    btnZip: document.getElementById('btnZip'),
    quality: document.getElementById('quality'),
    qval: document.getElementById('qval'),
    suffix: document.getElementById('suffix'),
    allowDownload: document.getElementById('allowDownload'),
    zipFolder: document.getElementById('zipFolder'),
  };

  // --- Handlers subida ---
  function accept(files){
    const arr = Array.from(files).filter(f => /image\/(jpeg|png)/.test(f.type));
    if(!arr.length) return;
      for(const f of arr){
        // size check
        const maxBytes = state.maxFileMB * 1024 * 1024;
        if(f.size > maxBytes){
          state.files.push({ file:f, name:f.name, status:'error', outName:null, blob:null, error:`Archivo mayor a ${state.maxFileMB}MB`, previewUrl:null, outputUrl:null });
          continue;
        }
        const obj = { file:f, name:f.name, status:'pendiente', outName:null, blob:null, error:null, previewUrl:null, outputUrl:null };
        // create preview from original file (robust across browsers)
        try{ obj.previewUrl = createSafeURL(f); }catch(e){ obj.previewUrl = null }
        state.files.push(obj);
      }
    render();
    el.btnConvert.disabled = false;
  }

  el.input.addEventListener('change', e => accept(e.target.files));

  ;['dragenter','dragover'].forEach(ev => el.drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); el.drop.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev => el.drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); el.drop.classList.remove('drag');}));
  el.drop.addEventListener('drop', e => accept(e.dataTransfer.files));

  // Accesibilidad con teclado para abrir file picker
  el.drop.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); el.input.click(); } });

  // Controles
  // Load prefs from localStorage
  try{
    const saved = JSON.parse(localStorage.getItem('xtravel_prefs')||'{}');
    if(saved.quality) { state.quality = saved.quality; el.quality.value = saved.quality; el.qval.textContent = saved.quality; }
    if(saved.suffix) { state.suffix = saved.suffix; el.suffix.value = saved.suffix; }
    if(typeof saved.allowDownload !== 'undefined'){ state.allowDownload = !!saved.allowDownload; }
    if(saved.zipFolder) state.zipFolder = saved.zipFolder;
  }catch(e){/* ignore */}
  // reflect checkbox initial state
  if(el.allowDownload) el.allowDownload.checked = !!state.allowDownload;
  if(el.zipFolder) el.zipFolder.value = state.zipFolder || 'webp';

  function savePrefs(){ localStorage.setItem('xtravel_prefs', JSON.stringify({quality: state.quality, suffix: state.suffix, allowDownload: state.allowDownload, zipFolder: state.zipFolder})); }

  el.quality.addEventListener('input', e=>{ state.quality = +e.target.value; el.qval.textContent = state.quality; savePrefs(); });
  el.suffix.addEventListener('input', e=>{ state.suffix = e.target.value || ''; savePrefs(); });
  if(el.allowDownload){ el.allowDownload.addEventListener('change', e=>{ state.allowDownload = !!e.target.checked; savePrefs(); render(); }); }
  if(el.zipFolder){ el.zipFolder.addEventListener('input', e=>{ state.zipFolder = e.target.value || 'webp'; savePrefs(); }); }

  // Cancel
  document.getElementById('btnCancel').addEventListener('click', ()=>{ state.isCancelled = true; state.files.filter(f=>f.status==='convirtiendo').forEach(f=> f.status='cancelado'); render(); });

  // Convertir
  el.btnConvert.addEventListener('click', async ()=>{
    el.btnConvert.disabled = true; el.btnZip.disabled = true;
    state.isCancelled = false;
    const usedNames = new Set();
    state.outputs = [];
    document.getElementById('globalProgress').style.display='flex';
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressText').textContent = '';
    for(const it of state.files){
      if(state.isCancelled) break;
      it.status = 'convirtiendo'; render();
      try{
        const file = it.file;
        const base = it.name.replace(/\.[^.]+$/, '');
        const norm = normalizeBase(base);
        const outBase = `${norm}${state.suffix}`;
        let outName = `${outBase}.webp`;
        outName = uniqueName(usedNames, outName);
        if(!state.supportedWebP) throw new Error('WebP no soportado en este navegador');
  const blob = await fileToWebP(file, state.quality);
  it.status = 'ok'; it.outName = outName; it.error = null;
  // revoke previous output url if present
  if(it.outputUrl) revokeSafeURL(it.outputUrl);
  it.blob = blob;
  try{ it.outputUrl = createSafeURL(blob); }catch(e){ it.outputUrl = null }
  // calculate savings
  it.originalSize = file.size;
  it.outputSize = blob.size;
  it.savings = Math.round((1 - (blob.size / file.size)) * 100);
  state.outputs.push({name: outName, blob});
      }catch(err){
        it.status = 'error'; it.error = (err && err.message) ? err.message : String(err);
      }
      render();
      // update progress
      const done = state.files.filter(f=>f.status==='ok' || f.status==='error' || f.status==='cancelado').length;
      const pct = Math.round((done / state.files.length) * 100);
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressText').textContent = `${done}/${state.files.length}`;
    }
    document.getElementById('globalProgress').style.display='none';
    el.btnZip.disabled = state.outputs.length === 0;
  });

  // Descargar ZIP con archivos + log
  el.btnZip.addEventListener('click', async ()=>{
  const zip = new JSZip();
  const znameBase = normalizeBase(state.zipFolder || 'webp') || 'webp';
  const folder = zip.folder(znameBase);

    // Guardar imágenes
    for(const out of state.outputs){
      folder.file(out.name, out.blob);
    }

    // Log
    const now = new Date();
    const pad = n => String(n).padStart(2,'0');
    const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

    const ok = state.files.filter(f=>f.status==='ok');
    const er = state.files.filter(f=>f.status==='error');
    let log = '';
    log += `Registro de conversión: ${stamp}\n`;
    log += `Calidad webp: ${state.quality}\n`;
    log += `Sufijo añadido: ${state.suffix}\n\n`;
    log += `Total procesados: ${state.files.length}\n`;
    log += `Éxitos: ${ok.length}\n`;
    log += `Errores: ${er.length}\n\n`;
    log += `DETALLES:\n`;
    for(const f of state.files){
      const final = f.outName ? f.outName : '-';
      const msg = f.status==='ok' ? 'OK' : (f.error ? `ERROR: ${f.error}` : '');
      log += `${f.name} -> ${final} -> ${msg}\n`;
    }
    folder.file('conversion_log.txt', log);

  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  // filename: YYYYMMDD-HHMM
  const fnameTime = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}`;
  a.download = `${znameBase}_${fnameTime}.zip`;
    document.body.appendChild(a); a.click(); a.remove();
  });

  // detect webp support
  (async function detectWebP(){
    try{
      const c = document.createElement('canvas');
      state.supportedWebP = c.toDataURL('image/webp').indexOf('data:image/webp') === 0;
    }catch(e){ state.supportedWebP = false }
    const notice = document.getElementById('notice');
    if(!state.supportedWebP){
      notice.textContent = 'Atención: tu navegador no parece soportar WebP. La conversión fallará.';
      notice.style.color = 'var(--danger)';
    }else{
      notice.textContent = `Límite por archivo: ${state.maxFileMB}MB — Calidad por defecto: ${state.quality}`;
    }
  })();

  // helper: create object URL safely
  function createSafeURL(blob){
    const url = URL.createObjectURL(blob);
    try{ state.urlMap.set(url, true); }catch(e){/* ignore */}
    return url;
  }

  function revokeSafeURL(url){
    try{
      if(!url) return;
      if(state.urlMap.has(url)){
        URL.revokeObjectURL(url);
        state.urlMap.delete(url);
      }
    }catch(e){/* ignore */}
  }

  // helper: descargar blob como archivo (usado si el usuario habilita descargas individuales)
  function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href = createSafeURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }

  function render(){
    el.list.innerHTML = '';
    if(state.files.length===0){
      el.list.innerHTML = '<div class="item"><div class="muted">Aún no hay archivos...</div></div>';
      return;
    }
    for(const it of state.files){
      const row = document.createElement('div'); row.className='item';
      const left = document.createElement('div'); left.className='name';
      const meta = document.createElement('div');
      left.textContent = it.name;
      // thumbnail
      const thumbWrap = document.createElement('div'); thumbWrap.style.display='flex'; thumbWrap.style.alignItems='center';
      const thumb = document.createElement('div'); thumb.className='thumb';
  // prefer original preview (JPEG/PNG) which is widely supported; fallback to converted outputUrl
  const thumbSrc = it.previewUrl || it.outputUrl || null;
  if(thumbSrc){ const img = document.createElement('img'); img.src = thumbSrc; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; thumb.appendChild(img); }
      thumbWrap.appendChild(thumb);
      const info = document.createElement('div'); info.style.marginLeft='8px';
      if(it.originalSize){
        const beforeKB = (it.originalSize/1024).toFixed(1);
        const afterKB = it.outputSize ? (it.outputSize/1024).toFixed(1) : '-';
        const sign = (it.savings > 0) ? '-' : (it.savings < 0 ? '+' : '');
        info.innerHTML = `<div class="tiny">${beforeKB} KB → ${afterKB} KB <strong>${sign}${Math.abs(it.savings)}%</strong></div>`;
      }else info.innerHTML = '<div class="tiny muted">Sin procesar</div>';
      thumbWrap.appendChild(info);

      const right = document.createElement('div');
      // buttons for download or retry
      if(it.status==='ok'){
        right.innerHTML = `<span class="ok">✔ ${it.outName}</span>` + (state.allowDownload ? ` <div style="margin-left:10px"><button class="btn" data-action="download">Descargar</button></div>` : '');
        if(state.allowDownload){ setTimeout(()=>{ const btn = right.querySelector('[data-action]'); if(btn) btn.addEventListener('click', ()=> downloadBlob(it.blob, it.outName)); },0); }
      }else if(it.status==='error'){
        right.innerHTML = `<span class="err">✖ ${it.error}</span> <div style="margin-left:10px"><button class="btn secondary" data-action="retry">Reintentar</button></div>`;
        setTimeout(()=>{ const btn = right.querySelector('[data-action]'); btn.addEventListener('click', ()=>{ it.status='pendiente'; it.error=null; render(); }); },0);
      }else if(it.status==='convirtiendo'){
        right.innerHTML = '<span class="muted">Convirtiendo…</span>';
      }else if(it.status==='cancelado'){
        right.innerHTML = '<span class="muted">Cancelado</span>';
      }else{
        right.innerHTML = '<span class="muted">Pendiente</span>';
      }
      row.appendChild(thumbWrap);
      row.appendChild(left);
      row.appendChild(right);
      el.list.appendChild(row);
    }
  }
</script>
</body>
</html>

